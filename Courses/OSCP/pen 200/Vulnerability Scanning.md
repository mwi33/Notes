The process of identifying the 'attack surface' of a piece of software, system or network is called vulnerability scanning.

Scanners are normally characterised as either web or network scanning.  
## How vulnerability scanners work
The basic workflow for vulnerability scanning is the same regardless of the tool or implementation.  These are:

1.  Host discovery;
2. Port scanning;
3. Operating system, service and version detection; and
4. Matching the results to a vulnerability database.

A vulnerability database is queried to match the data to a specific vulnerability.  Common vulnerability databases include:

1. [National Vulnerability Database](https://nvd.nist.gov/); and
2. [Common Vulnerabilities and Exposures (CVE) program.](https://cve.mitre.org/)

The [Common Vulnerability Scoring System (CVSS)](https://nvd.nist.gov/vuln-metrics/cvss) is a framework for addressing the characteristics and severity of vulnerabilities.  Each CVE has a CVSS score assigned.  A score of between 0-10 to rate vulnerabilities with different severity labels.  If there is no CVE assigned, then a calculator can be used to identify the severity.

It should be noted that vulnerabilities can be incorrect or inaccurate.  These can be in the following categories:

1.  False positive - Is a situation where a vulnerability is identified but it doesn't exist; and
2. False negative - When a vulnerability exists but is not identified.

Sometimes this can occur when patches or updates are backported, meaning that security fixes are applied to older versions of software.

A penetration test needs to find the balance between automated and manual vulnerability scanning.  

### Manual vulnerability scanning
A manual vulnerability scan will obviously resource intensive and time consuming.  When there is a huge amount of data to analyse we often reach our cognitive limit and overlook vital details.

On the other hand, manual vulnerability scanning is suited to complex and logical vulnerabilities that are difficult to identify with an automated scanner.
### Automated vulnerability scanning
As most engagement have limited time available, automated scanners are very useful.  Automated scanners are very good at identifying easily-detected vulnerabilities and other low hanging fruit.
## Types of vulnerability scans
In this section we will examine internal, external, authenticated and unauthenticated vulnerability scans.
## Things to consider when scanning
Time considerations
Target visibility
## Vulnerability scanning with Nessus
[Nessus](https://www.tenable.com/products/nessus)  Essentials and Nessus Professional are two different versions of the same application.  Nessus Essentials is a free product and Nessus Professional requires a paid license.

The Nessus application needs to be started through the 'systemctl' command.
~~~ bash

# this command shows the status of the nessus service
systemctl status nessusd.service

# starting nessus
systemctl start nessusd.service

~~~

The application is used through a web browser by using https://127.0.0.1/8834.  It also requires credentials to use the application.

Nessus uses policies to implement particular configurations for scanning.  These are saved as templates and can be reused.

Nessus plugins are programs written in the 'Nessus Attack Scripting Language' (NASL) that contain the information and algorithm to detect vulnerabilities.  Each plugin is assigned to a plugin family, which covers different use cases.   

### Authenticated scanning with Nessus
It should be noted that authenticated vulnerability scanning is very noisy, creating a lot of network traffic, including log entries and Anti Virus (AV) notifications.

For this exercise we will use the 'Credentialed Patch Audit' template rather than the 'Basic Network Scan'.  The primary difference between these is that the 'Credentialed Patch Audit' template only uses local security checks and will not do a regular vulnerability check from an external perspective.  This approach not only checks for missing OS patches but also for outdated application patches, which may be vulnerable to Privilege Escalation Attacks. 

# Working with Nessus plugins
By default Nessus is built on numerous plugins, which are used when default scans are run.  These plugins can be configured to run a single plugin.  We can use this plugin to quickly scan a target for a specific vulnerability.

We will modify a plugin to identify if a Desktop machine is vulnerable to CVE-2021-3156.  This is a locally exploited vulnerability that allows an unprivileged user to elevate privileges to root.

# Vulnerability scanning with nmap with NSE

Use the nmap scripting engine
Perform a light weight vulnerability scan with nmap
Work with custom (NMAP Scripting Environment) NSE scripts
Brute-forcing and network discovery

NMAP scripts have categories, including 'safe and vuln' or 'intrusive and vuln'.  Safe scripts are stable where intrusive scripts may crash or otherwise disrupt the target machine.

We can determine the category of script by browsing the [NMAP documentation](https://nmap.org/nsedoc/) or locally in the NSE scripts directory.

The local NSE scripts repository is at 'usr/share/nmap/scripts'.  This directory contains both the scripts themselves and the 'scripts.db' file, which serves as an index of all the available scripts.
~~~ bash

cd /usr/share/nmap/scripts

cat scripts.db

# nmap we can use a wildcard to run all of the scripts charcterised as 'vuln' this is done by using the following nmap parameters

sudo nmap -sV -p 443 --script "vuln" <IP>

~~~

## Working with NSE Scripts
We can download NSE scripts from the web and load them into the nmap scripts database.  

~~~ bash

#download the script from the web with the .nse file extension.

#copy the file into the /usr/share/nmap/scripts directory

#update the scripts databse

sudo nmap --script-updatedb

#then run the script

sudo nmap -sV -p 443 --script "http-vuln-cve-2021-41773" <IP>

~~~

## Tags
#vulnerabilityscanning
#nvd
#cve
#cvss
#automoatedvulnerabilityscanning
#manualvulnerabilityscanning
#internal
#external
#authenticated
#unauthenticated

